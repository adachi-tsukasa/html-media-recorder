<!DOCTYPE html>
<html lang="ja" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8" />
    <script>
      var current;
      var checkpoints = [];
      function hoge() {
        var video = document.getElementById("my-video");

        video.addEventListener("timeupdate", function ({ target }) {
          this.current = target.currentTime;
          generateThumbnail();
        });

        video.addEventListener("loadedmetadata", function ({ target }) {
          console.log("loadedmetadata");
          video.playbackRate = 10;
          var splitSec = video.duration / 5;
          for (let i = 0; i < 5; i++) {
            this.checkpoints.push(splitSec * (i + 1));
          }
          console.log(checkpoints);
        });

        function generateThumbnail() {
          var thecanvas = document.getElementById("canvas");
          var video = document.getElementById("my-video");
          var context = thecanvas.getContext("2d");
          context.drawImage(video, 0, 0, 220, 150);
          console.log(video);
          var dataURL = thecanvas.toDataURL();

          var img = document.createElement("img");
          img.setAttribute("src", dataURL);
          var label = document.createElement("img");
          label.nodeValue = this.current;

          document.getElementById("thumbnailContainer").appendChild(img);
          document.getElementById("thumbnailContainer").appendChild(label);
        }
      }
    </script>
  </head>
  <body onload="hoge();">
    <!-- <div class="camera">
      <video id="video">Video stream not available.</video>
    </div>
    <br />
    <button id="startbutton">start!!</button
    ><button id="stopbutton">stop!!</button
    ><button id="download">download!!</button><br />

    <form action="server.cgi" method="post" enctype="multipart/form-data">
      <input type="file" name="video" accept="video/*" capture="environment" />
      <input type="submit" value="Upload" />
    </form> -->

    <video id="my-video" controls autoplay>
      <source src="./myvideo.mp4" />
    </video>

    <div id="thumbnailContainer"></div>

    <canvas id="canvas"></canvas>

    <div>
      <video id="test"></video>
    </div>
    <!-- <script>
      let width = 320; // We will scale the photo width to this
      let height = 0; // This will be computed based on the input stream

      let streaming = false;

      let video = null;
      let canvas = null;
      let photo = null;
      let startbutton = null;
      let constrains = { video: true, audio: true };
      let recorder = null;
      let record_data = [];

      /**
       * ユーザーのデバイスによるカメラ表示を開始し、
       * 各ボタンの挙動を設定する
       *
       */
      function startup() {
        video = document.getElementById("video");
        canvas = document.getElementById("canvas");
        photo = document.getElementById("photo");
        startbutton = document.getElementById("startbutton");
        stopbutton = document.getElementById("stopbutton");
        downloadbutton = document.getElementById("download");

        videoStart();

        video.addEventListener(
          "canplay",
          function (ev) {
            if (!streaming) {
              height = video.videoHeight / (video.videoWidth / width);

              video.setAttribute("width", width);
              video.setAttribute("height", height);
              streaming = true;
            }
          },
          false
        );

        startRecorder();

        // 「start」ボタンをとる挙動を定義
        startbutton.addEventListener(
          "click",
          function (ev) {
            recorder.start();
            ev.preventDefault();
          },
          false
        );

        stopbutton.addEventListener("click", function (ev) {
          recorder.stop();
        });

        downloadbutton.addEventListener("click", function (ev) {
          console.log(record_data);
          var blob = new Blob(record_data, { type: "video/webm" });
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement("a");
          document.body.appendChild(a);
          a.style = "display:none";
          a.href = url;
          a.download = "test.webm";
          a.click();
          window.URL.revokeObjectURL(url);
        });
      }

      /**
       * カメラ操作を開始する
       */
      function videoStart() {
        streaming = false;
        console.log(streaming);
        navigator.mediaDevices
          .getUserMedia(constrains)
          .then(function (stream) {
            video.srcObject = stream;
            video.play();
          })
          .catch(function (err) {
            console.log("An error occured! " + err);
          });
      }

      function startRecorder() {
        navigator.mediaDevices.getUserMedia(constrains).then(function (stream) {
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = function (e) {
            var testvideo = document.getElementById("test");
            testvideo.setAttribute("controls", "");
            testvideo.setAttribute("width", width);
            testvideo.setAttribute("height", height);
            var outputdata = window.URL.createObjectURL(e.data);
            record_data.push(e.data);
            testvideo.src = outputdata;
          };
        });
      }

      startup();
    </script> -->
  </body>
</html>
